{% extends 'base.html' %}

{% block content %}
<div class="container py-3">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">

      <div class="card shadow-sm border-0">
        <!-- Header -->
        <div class="card-header bg-primary text-white p-3 border-0 rounded-top">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
            <div>
              <h4 class="mb-0">Rediger utlån</h4>
              <div class="small text-white-50">
                Oppdater informasjonen og lagre når du er ferdig
              </div>
            </div>

            <a href="{{ url_for('loan_detail', loan_id=loan.id) }}" class="btn btn-light btn-sm">
              <i class="fas fa-arrow-left me-1"></i> Tilbake
            </a>
          </div>
        </div>

        <div class="card-body p-4">
          <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Borrower section -->
            <div class="p-3 bg-light rounded-3 mb-3">
              <div class="fw-semibold mb-2">
                <i class="fas fa-user me-2 text-muted"></i> Låntaker
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small text-muted">Navn på elev/ansatt</label>
                  <input class="form-control" name="borrower_name" value="{{ loan.borrower_name }}" required>
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-muted">Klasse</label>
                  <input class="form-control" name="class_info" value="{{ loan.class_info or '' }}">
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-muted">Telefon</label>
                  <input class="form-control" name="borrower_phone" value="{{ loan.borrower_phone or '' }}">
                  <div class="form-text">Valgfritt, men nyttig ved oppfølging.</div>
                </div>
              </div>
            </div>

            <!-- Equipment section -->
            <div class="p-3 bg-light rounded-3 mb-3">
              <div class="fw-semibold mb-2">
                <i class="fas fa-laptop me-2 text-muted"></i> Utstyr
              </div>

              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label small text-muted" for="pc_search_input">
                    PC (fra oversikt)
                  </label>

                  <!-- Søkefelt + datalist for PC -->
                  {%- set current_pc = pcs
                  |selectattr('id', 'equalto', loan.pc_id)
                  |list
                  |first
                  -%}
                  <input type="text" class="form-control mb-2" id="pc_search_input" list="pc_list"
                    placeholder="Søk etter OK-nummer eller modell..."
                    value="{% if current_pc %}{{ current_pc.ok_number }} — {{ current_pc.model_type }}{% endif %}">

                  <datalist id="pc_list">
                    {% for pc in pcs %}
                    <option data-id="{{ pc.id }}" value="{{ pc.ok_number }}"
                      label="{{ pc.ok_number }} — {{ pc.model_type }}">
                    </option>
                    {% endfor %}
                  </datalist>


                  <!-- Skjult felt som faktisk sendes til serveren -->
                  <input type="hidden" name="pc_id" id="pc_id_hidden" value="{{ loan.pc_id or '' }}">

                  <div class="form-text">
                    Start å skrive for å søke. PC-en blir koblet til utlånet når du velger et treff.
                    La feltet stå tomt for å fjerne PC-koblingen.
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label small text-muted">Hva er utlånt</label>
                  <input class="form-control" name="item" value="{{ loan.item }}" required>
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-muted">Verdisak</label>
                  <input class="form-control" name="value" value="{{ loan.value or '' }}">
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-muted">Hvorfor</label>
                  <input class="form-control" name="reason" value="{{ loan.reason or '' }}">
                </div>
              </div>
            </div>

            <!-- Dates section -->
            <div class="p-3 bg-light rounded-3 mb-4">
              <div class="fw-semibold mb-2">
                <i class="fas fa-calendar-alt me-2 text-muted"></i> Frist
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small text-muted">Frist for innlevering</label>
                  <input type="date" class="form-control" name="due_date"
                    value="{% if loan.due_date %}{{ loan.due_date.strftime('%Y-%m-%d') }}{% endif %}">
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex flex-column flex-sm-row justify-content-end gap-2">
              <a href="{{ url_for('loan_detail', loan_id=loan.id) }}" class="btn btn-outline-secondary">
                Avbryt
              </a>
              <button class="btn btn-success">
                <i class="fas fa-save me-1"></i> Lagre endringer
              </button>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Liten JS-snutt for å koble valgt tekst til riktig pc_id -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const displayInput = document.getElementById('pc_search_input');
    const hiddenInput = document.getElementById('pc_id_hidden');
    const datalist = document.getElementById('pc_list');

    if (!displayInput || !hiddenInput || !datalist) return;

    displayInput.addEventListener('input', function () {
      const value = this.value;
      let matchedId = '';
      const options = datalist.querySelectorAll('option');

      options.forEach(function (opt) {
        if (opt.value === value) {
          matchedId = opt.getAttribute('data-id') || '';
        }
      });

      // Hvis ingen eksakt match, tømmer vi pc_id
      hiddenInput.value = matchedId;
    });
  });
</script>
{% endblock %}