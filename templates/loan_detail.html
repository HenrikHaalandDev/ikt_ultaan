{% extends 'base.html' %}

{% block content %}
<div class="container py-3">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">

      <div class="card shadow-sm border-0">
        <!-- Header -->
        <div class="card-header bg-primary text-white p-3 border-0 rounded-top">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
            <div class="d-flex align-items-center gap-2">
              <h4 class="mb-0">{{ t('Utlån detaljer') }}</h4>

              {% if loan.is_returned %}
              <span class="badge rounded-pill bg-success">
                <i class="fas fa-check me-1"></i> {{ t('Returnert') }}
              </span>
              {% else %}
              <span class="badge rounded-pill bg-warning text-dark">
                <i class="fas fa-clock me-1"></i> {{ t('Aktiv') }}
              </span>
              {% endif %}
            </div>

            <div class="d-flex gap-2">
              <a href="{{ url_for('dashboard') }}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i> {{ t('Tilbake') }}
              </a>
            </div>
          </div>
        </div>

        <div class="card-body p-4">

          <!-- Actions -->
          <div class="d-flex flex-wrap justify-content-end gap-2 mb-4">
            {% if (is_admin or is_owner) %}
            <a href="{{ url_for('edit_loan', loan_id=loan.id) }}" class="btn btn-primary btn-sm">
              <i class="fas fa-pen me-1"></i> {{ t('Rediger') }}
            </a>
            {% endif %}

            {% if not loan.is_returned and (is_admin or is_owner) %}
            <form method="post" action="{{ url_for('return_loan', loan_id=loan.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-success btn-sm">
                <i class="fas fa-check me-1"></i> {{ t('Marker som returnert') }}
              </button>
            </form>
            {% endif %}

            {% if is_admin %}
            <form method="post" action="{{ url_for('delete_loan', loan_id=loan.id) }}" class="d-inline"
              onsubmit="return confirm('{{ t('Er du sikker på at du vil slette dette utlånet? Denne handlingen kan ikke angres.') }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-trash me-1"></i> {{ t('Slett utlån') }}
              </button>
            </form>
            {% endif %}
          </div>

          <!-- Details grid -->
          <div class="row g-3">

            <!-- Borrower -->
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-1">{{ t('Navn på elev/ansatt') }}</div>
                <div class="fw-semibold">{{ loan.borrower_name }}</div>
              </div>
            </div>

            <!-- Class -->
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-1">{{ t('Klasse') }}</div>
                <div class="fw-semibold">
                  {% if loan.class_info %}
                  {{ class_t(loan.class_info) }}
                  {% else %}
                  {{ t('Ikke angitt') }}
                  {% endif %}
                </div>

              </div>
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-2">{{ t('Telefon') }}</div>
                {% if loan.borrower_phone %}
                <div class="d-flex align-items-center justify-content-between border rounded-3 bg-white px-3 py-2">
                  <a href="tel:{{ loan.borrower_phone }}" class="text-decoration-none fw-semibold">
                    <i class="fa-solid fa-phone me-2 text-success"></i>{{ loan.borrower_phone }}
                  </a>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="copyPhoneBtn"
                    title="Kopier nummer">
                    <i class="fa-regular fa-copy"></i>
                  </button>
                </div>
                <div class="text-muted small mt-1">
                  {{ t('Klikk nummeret for å ringe.') }}
                </div>
                {% else %}
                <div class="fw-semibold">{{ t('Ikke angitt') }}</div>
                {% endif %}
              </div>
            </div>

            <!-- PC -->
            {% if loan.pc %}
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-1">{{ t('PC (fra oversikt)') }}</div>
                <div class="fw-semibold">
                  {{ loan.pc.ok_number }} — {{ loan.pc.model_type }}
                </div>
                {% if loan.pc.notes %}
                <div class="text-muted small mt-1">
                  <i class="fas fa-note-sticky me-1"></i> {{ loan.pc.notes }}
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Item -->
            <div class="col-12">
              <div class="p-3 bg-light rounded-3">
                <div class="text-muted small mb-1">{{ t('Hva er utlånt') }}</div>
                <div class="fw-semibold">{{ item_t(loan.item) }}</div>
              </div>
            </div>

            <!-- Value -->
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-1">{{ t('Verdisak') }}</div>
                <div class="fw-semibold">{{ loan.value or t('Ikke angitt') }}</div>
              </div>
            </div>

            <!-- Reason -->
            <div class="col-md-6">
              <div class="detail-box h-100">

                <div class="text-muted small mb-1">{{ t('Hvorfor') }}</div>
                <div class="fw-semibold">{{ loan.reason or t('Ikke angitt') }}</div>
              </div>
            </div>

          </div>

          <!-- Dates strip -->
          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <div class="p-3 border rounded-3 h-100">
                <div class="text-muted small mb-1">{{ t('Utlånt dato/tid') }}</div>
                <div class="fw-semibold">
                  <i class="fas fa-calendar-plus me-1 text-muted"></i>
                  {{ loan.checkout_date_local.strftime('%Y-%m-%d %H:%M:%S') }}
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="p-3 border rounded-3 h-100">
                <div class="text-muted small mb-1">{{ t('Frist for innlevering') }}</div>
                <div class="fw-semibold">
                  <i class="fas fa-calendar-day me-1 text-muted"></i>
                  {% if loan.due_date %}
                  {{ loan.due_date.strftime('%Y-%m-%d') }}
                  {% else %}
                  {{ t('Ikke angitt') }}
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="p-3 border rounded-3 h-100">
                <div class="text-muted small mb-1">{{ t('Returnert dato/tid') }}</div>
                <div class="fw-semibold">
                  <i class="fas fa-calendar-check me-1 text-muted"></i>
                  {% if loan.return_date %}
                  {{ loan.return_date_local.strftime('%Y-%m-%d %H:%M:%S') }}
                  {% else %}
                  {{ t('Ikke returnert ennå') }}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Footer meta -->
          <div class="mt-4 p-3 bg-info bg-opacity-10 border border-info border-opacity-25 rounded-3">
            <div class="small text-muted">
              <div><strong>{{ t('Registrert av:') }}</strong> {{ loan.user.username }}</div>
              <div><strong>ID:</strong> #{{ loan.id }}</div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

{% if loan.borrower_phone %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('copyPhoneBtn');
    if (!btn) return;

    btn.addEventListener('click', function () {
      const phone = "{{ loan.borrower_phone }}";
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(phone).then(function () {
          alert('{{ t("Telefonnummer kopiert til utklippstavlen.") }}');
        }).catch(function () {
          alert('{{ t("Kunne ikke kopiere telefonnummer.") }}');
        });
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = phone;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          alert('{{ t("Telefonnummer kopiert til utklippstavlen.") }}');
        } catch (e) {
          alert('{{ t("Kunne ikke kopiere telefonnummer.") }}');
        }
        document.body.removeChild(textarea);
      }
    });
  });
</script>
{% endif %}
{% endblock %}